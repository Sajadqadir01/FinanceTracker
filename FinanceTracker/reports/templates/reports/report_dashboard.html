{% extends 'base.html' %}

{% block content %}
    <head>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <div class="container mt-5">
        <h2 class="mb-4">داشبورد گزارشات</h2>

        <!-- خلاصه مالی -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h5 class="card-title">کل درآمد</h5>
                        <p class="card-text">{{ income_total|floatformat:0 }} تومان</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-danger">
                    <div class="card-body">
                        <h5 class="card-title">کل هزینه</h5>
                        <p class="card-text">{{ expense_total|floatformat:0 }} تومان</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <h5 class="card-title">موجودی فعلی</h5>
                        <p class="card-text">{{ balance|floatformat:0 }} تومان</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- لیست تراکنش‌ها -->
        <div class="card">
            <div class="card-header">تراکنش‌های اخیر ({{ transaction_count }})</div>
            <div class="card-body p-0">
                <table class="table table-striped table-hover mb-0">
                    <thead class="thead-light">
                    <tr>
                        <th>تاریخ</th>
                        <th>مبلغ</th>
                        <th>نوع</th>
                        <th>دسته‌بندی</th>
                        <th>حساب</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for transaction in transactions %}
                        <tr>
                            <td>{{ transaction.date|date:"Y/m/d" }}</td>
                            <td>{{ transaction.amount|floatformat:0 }} تومان</td>
                            <td>
                                {% if transaction.transaction_type == 'income' %}
                                    <span class="text-success">درآمد</span>
                                {% else %}
                                    <span class="text-danger">هزینه</span>
                                {% endif %}
                            </td>
                            <td>{{ transaction.category.name }}</td>
                            <td>{{ transaction.account.name }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">هیچ تراکنشی ثبت نشده است.</td>
                        </tr>
                    {% endfor %}

                    <canvas id="myChart" width="400" height="200"></canvas>

                    <script>
                        const ctx = document.getElementById('myChart').getContext('2d');
                        const myChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: {{ labels|safe }},
                                datasets: [{
                                    label: 'درآمد',
                                    data: {{ income_data|safe }},
                                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                    borderWidth: 1
                                },
                                    {
                                        label: 'هزینه',
                                        data: {{ expense_data|safe }},
                                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                        borderWidth: 1
                                    }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    </script>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}
